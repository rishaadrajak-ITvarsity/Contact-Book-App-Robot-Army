<!DOCTYPE html>
<html lang="en">
    <head>
        <meta charset="UTF-8">
        <meta name="viewport" content="width=device-width, initial-scale=1.0">
        <title>Contact Book</title>
        <link rel="stylesheet" href="css/bootstrap.min.css">
        <link rel="stylesheet" href="fontawesome/css/all.min.css">
        <link rel="stylesheet" href="css/style.css">
    </head>

    <body onload="fetchContacts()">

        <div class="container text-center">
            <section class="row">
                <div id="table" class="col-md-6">
                    <div style="height:50vh">
                        <i class="fa-solid fa-cloud fa-5x fa-beat-fade position-relative top-50"></i>
                    </div>
                </div>
                <div id="infobox" class="col-5 position-fixed top-0">

                </div>
            </section>

            <div class="position-fixed">
                <div class="row">
                    <div class="col">
                        <!-- if sticky buttons dont respond well, remove div col above -->
                        <button id="refresh" type="button" 
                                class="bg-primary text-light border-white rounded-circle"
                                style="height:50px;width:50px">
                            <i class="fa fa-sync fs-4" style="margin-top:3px"></i>
                        </button>
                        <button id="addContact" type="button" 
                                class="bg-success text-light border-white rounded-circle mx-2"
                                style="height:50px;width:50px">
                            <i class="fa fa-add fs-3"></i>
                        </button>
                    </div>
                </div>
            </div>
            
        </div>

        <div class="modal fade" id="infoModal" tabindex="-1" aria-labelledby="infoModalLabel" aria-hidden="true">
            <div class="modal-dialog">
              <div class="modal-content pb-4">
                <div class="modal-header">
                  <!-- <h5 class="modal-title" id="infoModalLabel">Contact Info</h5> -->
                  <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="info-modal-body text-center">
                  

                    <!-- <div class="container-fluid mt-5">
                        <h3 class="fw-lighter">Contact Info</h3>
                        <div class="row mt-3">
                            <div id="avatarImage" class="col-12">
                                <img src="./defaultImg.png" class="col-4 mx-auto">
                            </div>
                        </div>
                        <form id="editForm" class="row">
                            <div class="col-1"></div>
                            <div class="col-10">
                                <label for="firstname" class="col-3 mt-4">First name</label>
                                <input name="firstname" class="col-8" type="text" id="firstname" readonly>
                                <label for="lastname"class="col-3 mt-4" >last name</label>
                                <input name="lastname" class="col-8" type="text" id="lastname" readonly>
                                <label for="mobile"class="col-3 mt-4" >Mobile</label>
                                <input name="mobile" class="col-8" type="text" id="mobile" readonly>
                                <label for="email"class="col-3 mt-4" >Email</label>
                                <input name="email" class="col-8" type="text" id="email" readonly>
                                <label for="avatar" class="col-3" id="avatarLabel" hidden>Change profile image</label><br>
                                <input name="avatar" class="col-8 mt-4" type="file" id="avatar" hidden>
                                <div class="row">
                                    <div id="formBtn1" class="col-6 mt-5 text-end">
                                        <button id="editContactBtn" type="button" class="rounded-circle fs-3 px-2 text-success border-success"><i class="fa-solid fa-pencil"></i></button>
                                    </div>
                                    <div id="formBtn2" class="col-6 mt-5 text-start">
                                        <button id="deleteContactBtn" type="button" class="rounded-circle fs-3 px-2 text-danger border-danger"><i class="fa-solid fa-trash"></i></button>
                                    </div>
                                </div>
                            </div>
                            <div class="col-1"></div>
                        </form>
                    </div> -->



                </div>
                <!-- <div class="info-modal-footer">
                  <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
                  <button type="button" class="btn btn-primary">Save changes</button>
                </div> -->
              </div>
            </div>
        </div>


        <script src="config.js"></script>
        <script src="js/bootstrap.min.js"></script>
        <script>
            document.getElementById("refresh").addEventListener('click', fetchContacts)
            document.getElementById("addContact").addEventListener('click', addContact)
            
            let lgScreen = window.innerWidth>1000; // check if big screen

            function fetchContacts(){
                fetch(rootPath+"controller/get-contacts/")
                .then(function(response){
                    return response.json()
                })
                .then(function(data){
                    console.log(data)
                    displayOutput(data)
                })
            }

            function displayOutput(data){
                const table = document.getElementById('table')
                let lastname=''
                let colSize = ['col-2','col-4','col-4']
                let output = ``
                console.log('large screen: '+lgScreen)
                const modalAttributes = `data-bs-toggle="modal" data-bs-target="#infoModal"`
                for(a in data){
                    lastname = data[a].lastname
                    if (window.innerWidth<250) {
                        lastname = lastname[0].toUpperCase()+'.'
                        colSize[0] = 'col-3'
                        colSize[1] = 'col-7'
                        colSize[2] = 'col-1'
                    }
                    output += `
                    <div class="">
                        <div class="row my-1 bg-secondary" onclick="getContact(${data[a].id}) ">
                            <div class="${colSize[0]} px-0">
                                <img src="${rootPath}controller/uploads/${data[a].avatar}" width="40">
                            </div>
                            <div class="${colSize[1]} text-start px-0 fs-3">
                                <p class="m-0 p-0">${data[a].firstname}</p>
                            </div>
                            <div class="${colSize[2]} text-start px-0 fs-3">
                                <p class="m-0 p-0">${lastname}</p>
                            </div>

                            ${(lgScreen)?``:`
                            <button type="button" class="btn" data-bs-toggle="modal" data-bs-target="#infoModal"
                                style="color: transparent; background: transparent; margin-top: -2.5rem">
                                Click for contact info
                            </button>`
                            }

                        </div>
                    </div>
                    `
                }
                output += ``
                table.innerHTML = output
            }

            function addContact(){
                window.open("add-contact.html", "_self")
            }

            // function editContact(id){
            //     window.open("edit-contact.html?id="+id, "_self")
            // }

            // DISPLAY INFO in index
            const infobox = document.getElementById('infobox')
            const outputInfoHTML = `
                <div class="container-fluid mt-5">
                    <h3 class="fw-lighter">Contact Info</h3>
                    <div class="row mt-3">
                        <div id="avatarImage" class="col-12">
                            <img src="./defaultImg.png" class="col-4 mx-auto">
                        </div>
                    </div>
                    <form id="editForm" class="row">
                        <div class="col-1"></div>
                        <div class="col-10">
                            <label for="firstname" class="col-3 mt-4">First name</label>
                            <input name="firstname" class="col-8" type="text" id="firstname" readonly>
                            <label for="lastname"class="col-3 mt-4" >last name</label>
                            <input name="lastname" class="col-8" type="text" id="lastname" readonly>
                            <label for="mobile"class="col-3 mt-4" >Mobile</label>
                            <input name="mobile" class="col-8" type="text" id="mobile" readonly>
                            <label for="email"class="col-3 mt-4" >Email</label>
                            <input name="email" class="col-8" type="text" id="email" readonly>
                            <label for="avatar" class="col-3" id="avatarLabel" hidden>Change profile image</label><br>
                            <input name="avatar" class="col-8 mt-4" type="file" id="avatar" hidden>
                            <div class="row">
                                <div id="formBtn1" class="col-6 mt-5 text-end">
                                    <button id="editContactBtn" type="button" class="rounded-circle fs-3 px-2 text-success border-success"><i class="fa-solid fa-pencil"></i></button>
                                </div>
                                <div id="formBtn2" class="col-6 mt-5 text-start">
                                    <button id="deleteContactBtn" type="button" class="rounded-circle fs-3 px-2 text-danger border-danger"><i class="fa-solid fa-trash"></i></button>
                                </div>
                            </div>
                        </div>
                        <div class="col-1"></div>
                    </form>
                </div>
            `
            if (lgScreen) {
                // large screen
                infobox.innerHTML = outputInfoHTML
            }else{
                // mobile view
                infobox.style = 'width: 0!important; padding:0;'
                document.getElementById('table').classList.replace('col-md-6','col-md-12')

                // innerHTML in modal
                document.querySelector('#infoModal .info-modal-body').innerHTML = outputInfoHTML
            }
            document.getElementById('editContactBtn').addEventListener('click', editContact)
            document.getElementById('deleteContactBtn').addEventListener('click', deleteContact)
            //document.getElementById('homeLink').addEventListener('click', homeLink)
            
            let currentID

            function getContact(id){
                currentID = id
                fetch(rootPath+'controller/get-contacts/?id=' + id)
                .then(function(response){
                    return response.json()
                })
                .then(function(data){
                    displayOutputInfo(data)
                })
            }

            function displayOutputInfo(data){
                avatarImg = `
                    <img src="${rootPath}/controller/uploads/${data[0].avatar}" 
                    class="col-4 m-auto">
                    `
                document.getElementById("avatarImage").innerHTML = avatarImg
                document.getElementById("firstname").value = data[0].firstname
                document.getElementById("lastname").value = data[0].lastname
                document.getElementById("mobile").value = data[0].mobile
                document.getElementById("email").value = data[0].email
            }
                
            function editContact(){
                const editBtn   = `<button id="editContactBtn" type="button" class="rounded-circle fs-3 px-2 text-success border-success"><i class="fa-solid fa-pencil"></i></button>`
                const deleteBtn = `<button id="deleteContactBtn" type="button" class="rounded-circle fs-3 px-2 text-danger border-danger"><i class="fa-solid fa-trash"></i></button>`
                const submitBtn = `<button id="submitForm" type="submit" class="rounded-circle fs-3 px-2 text-success border-success"><i class="fa-solid fa-check"></i></button>`
                const cancelBtn = `<button id="cancelBtn" type="button" class="rounded-circle fs-3 px-2 text-danger border-danger"><i class="fa-solid fa-x"></i></button>`

                document.getElementById("firstname").readOnly   = !document.getElementById("firstname").readOnly    //false (initial value)
                document.getElementById("lastname").readOnly    = !document.getElementById("lastname").readOnly     //false
                document.getElementById("mobile").readOnly      = !document.getElementById("mobile").readOnly       //false
                document.getElementById("email").readOnly       = !document.getElementById("email").readOnly        //false
                //document.getElementById("avatar").hidden        = !document.getElementById("avatar").hidden         //false
                
                //document.getElementById("submitForm").hidden    = document.getElementById("submitForm").hidden     //false
                //document.getElementById("cancelBtn").hidden     = document.getElementById("cancelBtn").hidden      //false
                
                //document.getElementById('editContactBtn').hidden    = document.getElementById('editContactBtn').hidden     //true
                //document.getElementById('deleteContactBtn').hidden  = document.getElementById('deleteContactBtn').hidden   //true

                if (document.getElementById('firstname').readOnly) {
                    document.getElementById('formBtn1').innerHTML = editBtn
                    document.getElementById('formBtn2').innerHTML = deleteBtn
                    document.getElementById('editContactBtn').addEventListener('click', editContact)
                    document.getElementById('deleteContactBtn').addEventListener('click', deleteContact)
                    document.querySelector('#avatarImage').innerHTML = document.querySelector('#avatarImage').innerHTML // clear eventListener
                }else{
                    // EDIT MODE
                    document.getElementById('formBtn1').innerHTML = submitBtn
                    document.getElementById('formBtn2').innerHTML = cancelBtn
                    document.getElementById('submitForm').addEventListener('click', submitForm)
                    document.getElementById('cancelBtn').addEventListener('click', () => {
                        editContact()
                        getContact(currentID)
                    })
                    document.querySelector('#avatarImage>img').addEventListener('click', () => {
                        document.getElementById('avatar').click()
                    })
                }
                //console.log("form is READONLY: "+document.getElementById('firstname').readOnly)
            }

            function submitForm(e){
                e.preventDefault()

                let id = currentID

                const form = new FormData(document.querySelector("#editForm"))
                form.append('apiKey', apiKey)
                form.append('id', id)

                fetch(rootPath+'controller/edit-contact/', {
                    method: 'POST',
                    headers: {'Accept': 'application/json, *.*'},
                    body: form
                })
                .then(function(response){
                    return response.text()
                })
                .then(function(data){
                    if(lgScreen){
                        if(data=="1"){
                            alert("Contact Edited.")
                        }else{
                            alert(data)
                        }
                    }else{
                        document.querySelector('#infoModal .btn-close').click()
                    }
                    fetchContacts()
                    editContact()
                })

            }

            function deleteContact(){
                let id = currentID
                let confirmDelete = false
                if(lgScreen){
                    confirmDelete = confirm("Delete contact. Are you sure?")
                }else{
                    // no comfirm delete when using mobile
                    confirmDelete = true
                }

                if (confirmDelete == true) {
                    fetch(rootPath+'controller/delete-contact/?id='+id)
                    .then(function(response){
                        return response.text()
                    })
                    .then(function(data){
                        if (data=="1") {
                            //homeLink()
                            fetchContacts()
                            if(lgScreen){
                                infobox.innerHTML = outputInfoHTML
                            }else{
                                document.querySelector('#infoModal .btn-close').click()
                            }
                        }else{
                            if(lgScreen){
                                alert(data)
                            }
                        }
                    })
                }
            }

        </script>
    </body>
</html>