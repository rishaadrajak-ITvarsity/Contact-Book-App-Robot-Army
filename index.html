<!DOCTYPE html>
<html lang="en">
    <head>
        <meta charset="UTF-8">
        <meta name="viewport" content="width=device-width, initial-scale=1.0">
        <title>Contact Book</title>
        <link rel="stylesheet" href="css/bootstrap.min.css">
        <link rel="stylesheet" href="fontawesome/css/all.min.css">
        <link rel="stylesheet" href="css/style.css">
    </head>

    <body onload="fetchContacts()">

        <div class="container-fluid text-center overflow-x-hidden">
            <div class="row">
                <h2 class="fw-lighter mt-3 col-md-6 text-center px-5">Contact List</h2>
            </div>
            <section class="row">
                <div id="table" class="col-md-6 ms-sm-3 ms-md-5">
                    <div style="height:50vh">
                        <i class="fa-solid fa-cloud fa-5x fa-beat-fade position-relative top-50"></i>
                    </div>
                </div>
                <div id="infobox" class="col-6 position-fixed top-0 end-0">

                </div>
            </section>

            <div class="position-fixed">
                <div class="row">
                    <div class="col">
                        <!-- if sticky buttons dont respond well, remove div col above -->
                        <button id="refresh" type="button" 
                                class="btn custom-bg-primary text-light border-white rounded-circle"
                                style="height:50px;width:50px">
                            <i class="fa fa-sync fs-4" style="margin-top:3px"></i>
                        </button>
                        <button id="addContact" type="button"
                                data-bs-toggle="modal" data-bs-target="#addContactModal"
                                class="btn custom-bg-secondary text-light border-white rounded-circle mx-2"
                                style="height:50px;width:50px">
                            <i class="fa fa-add fs-3"></i>
                        </button>
                    </div>
                </div>
            </div>
            
        </div>

        <div class="modal fade" id="infoModal" tabindex="-1" aria-labelledby="infoModalLabel" aria-hidden="true">
            <div class="modal-dialog">
              <div class="modal-content pb-4">
                <div class="modal-header">
                  <!-- <h5 class="modal-title" id="infoModalLabel">Contact Info</h5> -->
                  <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="info-modal-body text-center">
                  
                    <!-- <div class="container-fluid mt-5">
                        <h2 class="fw-lighter">Contact Info</h2>
                        <div class="row mt-3">
                            <div id="avatarImage" class="col-12">
                                <img src="./defaultImg.png" class="col-4 mx-auto">
                            </div>
                        </div>
                        <form id="editForm" class="row">
                            <div class="col-1"></div>
                            <div class="col-10">
                                <label for="firstname" class="col-3 mt-4">First name</label>
                                <input name="firstname" class="col-8" type="text" id="firstname" readonly>
                                <label for="lastname"class="col-3 mt-4" >last name</label>
                                <input name="lastname" class="col-8" type="text" id="lastname" readonly>
                                <label for="mobile"class="col-3 mt-4" >Mobile</label>
                                <input name="mobile" class="col-8" type="text" id="mobile" readonly>
                                <label for="email"class="col-3 mt-4" >Email</label>
                                <input name="email" class="col-8" type="text" id="email" readonly>
                                <label for="avatar" class="col-3" id="avatarLabel" hidden>Change profile image</label><br>
                                <input name="avatar" class="col-8 mt-4" type="file" id="avatar" hidden>
                                <div class="row">
                                    <div id="formBtn1" class="col-6 mt-5 text-end">
                                        <button id="editContactBtn" type="button" class="rounded-circle fs-3 px-2 text-success border-success"><i class="fa-solid fa-pencil"></i></button>
                                    </div>
                                    <div id="formBtn2" class="col-6 mt-5 text-start">
                                        <button id="deleteContactBtn" type="button" class="rounded-circle fs-3 px-2 text-danger border-danger"><i class="fa-solid fa-trash"></i></button>
                                    </div>
                                </div>
                            </div>
                            <div class="col-1"></div>
                        </form>
                    </div> -->

                </div>
                <!-- <div class="info-modal-footer">
                  <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
                  <button type="button" class="btn btn-primary">Save changes</button>
                </div> -->
              </div>
            </div>
        </div>



        <div class="modal fade" id="addContactModal" tabindex="-1" aria-labelledby="addContactModalLabel" aria-hidden="true">
            <div class="modal-dialog">
              <div class="modal-content pb-4">
                <div class="modal-header">
                  <!-- <h5 class="modal-title" id="addContactModalLabel">Add Contact</h5> -->
                  <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="add-modal-body text-center">

                    <div class="container-fluid mt-3">
                        <h2 class="fw-lighter">Add Contact</h2>
                        <div class="row mt-3">
                            <div id="addAvatarImage" class="col-12">
                                <img src="./defaultImg.png" class="col-4 mx-auto">
                            </div>
                        </div>
                        <form id="addForm" class="row mt-3">
                            <!-- <div class="col-1"></div> -->
                            <!-- <div class="col-12"> -->
                                <label class='col-8 col-sm-4 mx-auto mx-sm-0 text-sm-end mt-2 mt-sm-0 fw-semibold' for="firstname">First name</label>
                                <input class='col-8 col-sm-6 mx-auto mx-sm-0 mb-sm-3 text-center' name="firstname" type="text" id="firstnameNew">
                                <label class='col-8 col-sm-4 mx-auto mx-sm-0 text-sm-end mt-2 mt-sm-0 fw-semibold' for="lastname">Last name</label>
                                <input class='col-8 col-sm-6 mx-auto mx-sm-0 mb-sm-3 text-center' name="lastname" type="text" id="lastnameNew">
                                <label class='col-8 col-sm-4 mx-auto mx-sm-0 text-sm-end mt-2 mt-sm-0 fw-semibold' for="mobile">Mobile</label>
                                <input class='col-8 col-sm-6 mx-auto mx-sm-0 mb-sm-3 text-center' name="mobile" type="text" id="mobileNew">
                                <label class='col-8 col-sm-4 mx-auto mx-sm-0 text-sm-end mt-2 mt-sm-0 fw-semibold' for="email">Email</label>
                                <input class='col-8 col-sm-6 mx-auto mx-sm-0 mb-sm-3 text-center' name="email" type="text" id="emailNew">
                                <label class='col-8 col-sm-4 mx-auto mx-sm-0 text-sm-end mt-2 mt-sm-0 fw-semibold' for="avatar" id="avatarLabel" hidden>Avatar</label>
                                <input class='col-8 col-sm-6 mx-auto mx-sm-0 mb-sm-3 text-center' name="avatar" type="file" id="avatarNew" onchange='updateImg(this, "addAvatarImage")' hidden>
                                <div class="row px-0 mx-auto">
                                    <div id="formSubmit" class="col-6 mt-4 text-end">
                                        <button id="btnAddContact" type="submit" class="rounded-circle fs-3 px-2 custom-text-success custom-border-success"><i class="fa-solid fa-check"></i></button>
                                    </div>
                                    <div id="formCancel" class="col-6 mt-4 text-start">
                                        <button id="btnCancelAdd" type="button" class="rounded-circle fs-3 px-2 custom-text-danger custom-border-danger"><i class="fa-solid fa-x"></i></button>
                                    </div>
                                </div>
                            <!-- </div> -->
                            <!-- <div class="col-1"></div> -->
                        </form>
                    </div>

                </div>
                <!-- <div class="info-modal-footer">
                  <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
                  <button type="button" class="btn btn-primary">Save changes</button>
                </div> -->
              </div>
            </div>
        </div>




        <script src="config.js"></script>
        <script src="js/bootstrap.min.js"></script>
        <script>
            document.getElementById("refresh").addEventListener('click', fetchContacts)
            document.getElementById("addContact").addEventListener('click', addContact)
            
            let lgScreen = window.innerWidth>1000 // check if big screen

            function fetchContacts(){
                fetch(rootPath+"controller/get-contacts/")
                .then(function(response){
                    return response.json()
                })
                .then(function(data){
                    console.log(data)
                    displayOutput(data)
                })
            }

            function displayOutput(data){
                const table = document.getElementById('table')
                let lastname=''
                let firstname=''
                let colSize = 'col-3'
                //let colSize = ['col-2','col-4','col-4']
                let output = `<div class="row justify-content-center justify-content-sm-start">`
                //console.log('large screen: '+lgScreen)
                //const modalAttributes = `data-bs-toggle="modal" data-bs-target="#infoModal"`
                for(a in data){
                    lastname = data[a].lastname
                    firstname = data[a].firstname
                    if (window.innerWidth<270) {
                        lastname = lastname.slice(0,4)+'.'
                        firstname = firstname.slice(0,4)+'.'
                        colSize = 'col-5'
                        //colSize[0] = 'col-3'
                        //colSize[1] = 'col-7'
                        //colSize[2] = 'col-1'
                    }
                    // change col-3 to col-5 when width < 300
                    output += `
                            <div class="${colSize} col-sm-2 m-1" onclick="getContact(${data[a].id})">
                                <img src="${rootPath}controller/uploads/${data[a].avatar}" width="60">
                                <p class="m-0 p-0">${data[a].firstname}</p>
                                <p class="m-0 p-0">${lastname}</p>
                                ${(lgScreen)?``:`
                                <button type="button" class="btn" data-bs-toggle="modal" data-bs-target="#infoModal"
                                    style="color: transparent; background: rgba(255,255,0,0); margin-top: -6rem">
                                    Click for contact info
                                </button>`
                                }
                            </div>                 
                    `
                }
                output += `</div>`
                table.innerHTML = output
                if(lgScreen){
                    getContact(data[0].id)
                }
            }

            function addContact(){
                document.getElementById('addForm').reset()
                
                // replaced with addModal
                //window.open("add-contact.html", "_self")
            }

            // replaced with infoModal
            // function editContact(id){
            //     window.open("edit-contact.html?id="+id, "_self")
            // }

            // DISPLAY INFO in index
            const infobox = document.getElementById('infobox')
            const outputInfoHTML = `
                <div class="container-fluid mt-3">
                    <h2 class="fw-lighter">Contact Info</h2>
                    <div class="row mt-3">
                        <div id="avatarImage" class="col-12">
                            <img src="./defaultImg.png" class="col-4 mx-auto">
                        </div>
                    </div>
                    <form id="editForm" class="row mt-3">
                        <label class='col-8 col-sm-4 mx-auto mx-sm-0 text-sm-end mt-2 mt-sm-0 fw-semibold' for="firstname">First name</label>
                        <input class='col-8 col-sm-6 mx-auto mx-sm-0 mb-sm-3 text-center text-sm-start' name="firstname" type="text" id="firstname" readonly>
                        <label class='col-8 col-sm-4 mx-auto mx-sm-0 text-sm-end mt-2 mt-sm-0 fw-semibold' for="lastname">Last name</label>
                        <input class='col-8 col-sm-6 mx-auto mx-sm-0 mb-sm-3 text-center text-sm-start' name="lastname" type="text" id="lastname" readonly>
                        <label class='col-8 col-sm-4 mx-auto mx-sm-0 text-sm-end mt-2 mt-sm-0 fw-semibold' for="mobile">Mobile</label>
                        <input class='col-8 col-sm-6 mx-auto mx-sm-0 mb-sm-3 text-center text-sm-start' name="mobile" type="text" id="mobile" readonly>
                        <label class='col-8 col-sm-4 mx-auto mx-sm-0 text-sm-end mt-2 mt-sm-0 fw-semibold' for="email">Email</label>
                        <input class='col-8 col-sm-6 mx-auto mx-sm-0 mb-sm-3 text-center text-sm-start' name="email" type="text" id="email" readonly>
                        <label class='col-8 col-sm-4 mx-auto mx-sm-0 text-sm-end mt-2 mt-sm-0 fw-semibold' for="avatar" class="col-3" id="avatarLabel" hidden>Change profile image</label>
                        <input class='col-8 col-sm-6 mx-auto mx-sm-0 mb-sm-3 text-center text-sm-start' name="avatar" class="col-8 mt-4" type="file" id="avatar" onchange='updateImg(this, 'avatarImage')' hidden>
                        <div class="row px-0 mx-auto">
                            <div id="formBtn1" class="col-6 mt-4 text-end">
                                <button id="editContactBtn" type="button" onclick='editContact()' class="rounded-circle fs-3 px-2 custom-text-success custom-border-success"><i class="fa-solid fa-pencil"></i></button>
                            </div>
                            <div id="formBtn2" class="col-6 mt-4 text-start">
                                <button id="deleteContactBtn" type="button" onclick='deleteContact()' class="rounded-circle fs-3 px-2 custom-text-danger custom-border-danger"><i class="fa-solid fa-trash"></i></button>
                            </div>
                        </div>
                    </form>
                </div>
            `
            if (lgScreen) {
                // large screen
                infobox.innerHTML = outputInfoHTML
            }else{
                // mobile view
                infobox.style = 'width: 0!important; padding:0;'
                document.getElementById('table').classList.replace('col-md-6','col-md-12')

                // innerHTML in modal
                document.querySelector('#infoModal .info-modal-body').innerHTML = outputInfoHTML
            }
            ////document.getElementById('editContactBtn').addEventListener('click', editContact)
            ////document.getElementById('deleteContactBtn').addEventListener('click', deleteContact)
            //document.getElementById('homeLink').addEventListener('click', homeLink)
            
            let currentID

            function getContact(id){
                currentID = id
                fetch(rootPath+'controller/get-contacts/?id=' + id)
                .then(function(response){
                    return response.json()
                })
                .then(function(data){
                    displayOutputInfo(data)
                })
            }

            function displayOutputInfo(data){
                avatarImg = `
                    <img src="${rootPath}/controller/uploads/${data[0].avatar}" 
                    class="col-4 m-auto">
                    `
                document.getElementById("avatarImage").innerHTML = avatarImg
                document.getElementById("firstname").value = data[0].firstname
                document.getElementById("lastname").value = data[0].lastname
                document.getElementById("mobile").value = data[0].mobile
                document.getElementById("email").value = data[0].email
            }
                
            function editContact(){
                const editBtn   = `<button id="editContactBtn" type="button" onclick='editContact()' class="rounded-circle fs-3 px-2 custom-text-success custom-border-success"><i class="fa-solid fa-pencil"></i></button>`
                const deleteBtn = `<button id="deleteContactBtn" type="button" onclick='deleteContact()' class="rounded-circle fs-3 px-2 custom-text-danger custom-border-danger"><i class="fa-solid fa-trash"></i></button>`
                const submitBtn = `<button id="submitForm" type="submit" class="rounded-circle fs-3 px-2 custom-text-success custom-border-success"><i class="fa-solid fa-check"></i></button>`
                const cancelBtn = `<button id="cancelBtn" type="button" class="rounded-circle fs-3 px-2 custom-text-danger custom-border-danger"><i class="fa-solid fa-x"></i></button>`

                document.getElementById("firstname").readOnly   = !document.getElementById("firstname").readOnly    //false (initial value)
                document.getElementById("lastname").readOnly    = !document.getElementById("lastname").readOnly     //false
                document.getElementById("mobile").readOnly      = !document.getElementById("mobile").readOnly       //false
                document.getElementById("email").readOnly       = !document.getElementById("email").readOnly        //false
                //document.getElementById("avatar").hidden        = !document.getElementById("avatar").hidden         //false
                
                //document.getElementById("submitForm").hidden    = document.getElementById("submitForm").hidden     //false
                //document.getElementById("cancelBtn").hidden     = document.getElementById("cancelBtn").hidden      //false
                
                //document.getElementById('editContactBtn').hidden    = document.getElementById('editContactBtn').hidden     //true
                //document.getElementById('deleteContactBtn').hidden  = document.getElementById('deleteContactBtn').hidden   //true

                if (document.getElementById('firstname').readOnly) {
                    document.getElementById('formBtn1').innerHTML = editBtn
                    document.getElementById('formBtn2').innerHTML = deleteBtn
                    //document.getElementById('editContactBtn').addEventListener('click', editContact)
                    //document.getElementById('deleteContactBtn').addEventListener('click', deleteContact)
                    document.querySelector('#avatarImage').innerHTML = document.querySelector('#avatarImage').innerHTML // clear eventListener
                }else{
                    // EDIT MODE
                    document.getElementById('formBtn1').innerHTML = submitBtn
                    document.getElementById('formBtn2').innerHTML = cancelBtn
                    document.getElementById('submitForm').addEventListener('click', submitForm)
                    document.getElementById('cancelBtn').addEventListener('click', () => {
                        editContact()
                        getContact(currentID)
                    })
                    document.querySelector('#avatarImage>img').addEventListener('click', () => {
                        document.getElementById('avatar').click()
                    })
                }
                //console.log("form is READONLY: "+document.getElementById('firstname').readOnly)
            }

            function submitForm(e){
                e.preventDefault()

                let id = currentID

                const form = new FormData(document.querySelector("#editForm"))
                form.append('apiKey', apiKey)
                form.append('id', id)

                fetch(rootPath+'controller/edit-contact/', {
                    method: 'POST',
                    headers: {'Accept': 'application/json, *.*'},
                    body: form
                })
                .then(function(response){
                    return response.text()
                })
                .then(function(data){
                    if(lgScreen){
                        if(data=="1"){
                            alert("Contact Edited.")
                        }else{
                            alert(data)
                        }
                    }else{
                        document.querySelector('#infoModal .btn-close').click()
                    }
                    fetchContacts()
                    editContact()
                })

            }

            function deleteContact(){
                let id = currentID
                let confirmDelete = false
                if(lgScreen){
                    confirmDelete = confirm("Delete contact. Are you sure?")
                }else{
                    // no comfirm delete when using mobile
                    confirmDelete = true
                }

                if (confirmDelete == true) {
                    fetch(rootPath+'controller/delete-contact/?id='+id)
                    .then(function(response){
                        return response.text()
                    })
                    .then(function(data){
                        if (data=="1") {
                            //homeLink()
                            fetchContacts()
                            if(lgScreen){
                                infobox.innerHTML = outputInfoHTML
                            }else{
                                document.querySelector('#infoModal .btn-close').click()
                            }
                        }else{
                            if(lgScreen){
                                alert(data)
                            }
                        }
                    })
                }
            }

            // add contact using modal
            document.getElementById('btnCancelAdd').addEventListener('click', () => {
                document.querySelector('#addContactModal .btn-close').click()
            })
            document.getElementById('btnAddContact').addEventListener('click', submitAddContactForm)


            function submitAddContactForm(e){
                e.preventDefault()

                const form = new FormData(document.querySelector('#addForm'))
                form.append('apiKey', apiKey)

                fetch(rootPath + 'controller/insert-contact/', {
                    method: 'POST',
                    headers: {'Accept':'application/json, *.*'},
                    body: form
                })
                .then(function(response){
                    return response.text()
                })
                .then(function(data){
                    fetchContacts()
                    document.querySelector('#addContactModal .btn-close').click()
                    //document.getElementById('addForm').reset()
                    if (data == "1") {
                        alert("Contact added.")
                    }else{
                        alert(data)
                    }
                    //homeLink()
                })
            }

            document.querySelector('#addAvatarImage>img').addEventListener('click', () => {
                document.getElementById('addAvatar').click()
            })

            // function addContact(){
            //     let outputAddHTML = ``
            //     document.querySelector('#addContactModal .add-modal-body').innerHTML = outputAddHTML
            // }


            function updateImg(file, id){
                file = file.files[0]
                url = URL.createObjectURL(file)
                document.querySelector('#'+id+' img').src =  url
            }

            // START TEST CODE: LOAD TEST DATA
            let test = confirm('get test data?')
            if(test){
                getTestData()
            }

            const firstname = document.getElementById('firstnameNew')
            const lastname = document.getElementById('lastnameNew')
            const mobile = document.getElementById('mobileNew')
            const email = document.getElementById('emailNew')
            
            function getTestData(){
                fetch('https://random-data-api.com/api/users/random_user?size=5')
                .then(function(response){
                    return response.json()
                })
                .then(function(data){   
                    for(i in data){
                        firstname.value = data[i]['first_name']
                        lastname.value = data[i]['last_name']
                        mobile.value = data[i]['phone_number'].slice(0,14).replaceAll('.','').replaceAll('-','')
                        email.value = data[i]['email']
                        const form = new FormData(document.querySelector('#addForm'))
                        form.append('apiKey', apiKey)

                        fetch(data[i]['avatar'])
                        .then(function(resp){
                            return resp.blob()
                        })
                        .then(function(blob){
                            let file = new File([blob],'image.png',{
                                lastModified: 1654443013251,
                                lastModifiedDate: new Date,
                                name: 'newfile.png',
                                size: this.size,
                                type: "image/png",
                                webkitRelativePath: ""
                            })
                            form.append('avatar', file)
                            //console.log(...form)
                            fetch(rootPath + 'controller/insert-contact/', {
                                method: 'POST',
                                headers: {'Accept':'application/json, *.*'},
                                body: form
                            })
                            .then(function(response){
                                return response.text()
                            })
                            .then(function(data){
                                if (data == "1") {
                                    console.log("Contact added.")
                                }else{
                                    console.log(data)
                                }
                                document.getElementById("refresh").click()
                            })
                        })    
                    }
                })
                //refresh fetchContacts()
            }
            // END TEST CODE


        </script>
    </body>
</html>